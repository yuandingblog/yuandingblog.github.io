---
layout:     post
title:     利用蓝鲸标准运维实现持续交付
subtitle:     蓝鲸标准运维使用场景介绍（2）
date:       2019-03-20
author:     李柱 宋延鹏
header-img: img/post-bg-universe.jpg
catalog: true
tags:
    - 蓝鲸
    - 自动化运维
    - 标准运维
    - 元鼎
---

> 在上一篇文章[利用蓝鲸标准运维实现Oracle DataGuard一键切换上篇文章](http://blog.yuandingit.com/2019/03/17/blueking-sops/)中，我们介绍了利用标准运维实现Oracle ADG切换的场景。本文是蓝鲸标准运维使用场景的第二篇，通过一个企业常见发布场景，介绍标准运维在发版流程编排方面的使用。

# 标准运维简介

蓝鲸智云，简称蓝鲸，是腾讯游戏运营部“腾讯智营”下的子品牌。它是一套基于PaaS的企业研发运营一体化技术解决方案，提供了一个完整的研发、运维、运营的PaaS技术平台。平台提供了完善的前后台开发框架、调度引擎、公共组件等模块，帮助业务的产品和技术人员快速构建低成本、免运维的支撑工具和运营系统；是腾讯游戏运营部沉淀多年的技术运营支撑体系，承担着数百款业务线上运营的使命。

标准运维是一套通过成熟稳定的任务调度引擎，把多系统间的工作整合到一个流程，助力运维实现跨系统调度自动化的'SaaS'应用。标准运维拥有可视化的图形界面，用户可通过它实现任务流程编排和执行，包括发布、变更、开区、扩缩容等执行类操作场景。

简而言之，蓝鲸是监管控一体的PaaS运维平台，标准运维是蓝鲸平台其中的一个官方SaaS。

![sops-02-01](http://img.yuandingit.com/sops-02-01.png)

用户可以通过对标准插件节点、子流程节点与网关节点的组合，变量的配置与引用，配置出一个业务流程。

![流程编排](https://docs.bk.tencent.com/product_white_paper/gcloud/assets/101.png)
![配置参数](https://docs.bk.tencent.com/product_white_paper/gcloud/assets/102.png)
![流程列表](https://docs.bk.tencent.com/product_white_paper/gcloud/assets/9.png)

# 为什么应用要实现自动发布？

随着业务的不断发展，企业应用系统也变得越来越复杂，而部署包含多个组件的应用程序更是极具挑战性：第一个挑战是确定应部署的每个组件的版本，另一个挑战是将所有组件的所需版本传送到目标环境上，并执行相应的部署逻辑。

另外，业务要求带来了更频繁的发布，如果仅仅依靠运维人员的手工部署，一方面效率低、易出错，另外也无法满足不断增加的各种流程和环境。所以，开发人员对自助发布的需求越来越强烈。应用发布并不仅仅是自动化，流程必须是模块化和精心设计的，环境和配置也必须纳入统一管理。自动化工具必须为洪湖提供每个流程步骤的可见性，流程必须是可靠且可重复的，能够以自助化服务方式将它交给职能人员操作。另外执行历史都必须是可追溯的，比如：谁在哪里、何时做了什么。一切都必须是安全的，要求能通过审批来实现一键发布，发布结果可以通过短信、邮件方式快速反馈。

# 通过蓝鲸标准运维实现CD（持续交付）

> 蓝鲸管控平台是整个蓝鲸平台的底层管控系统，是蓝鲸所有其他服务的基础。管控平台通过Agent为蓝鲸其他平台提供了人机交互的通道与能力。蓝鲸管控平台主要提供了三种类型的服务能力：文件分发传输能力、命令实时执行与反馈的能力、大数据采集与传输的能力。


蓝鲸依托管控平台，以及上面介绍的流程编排利器`标准运维`来实现应用自动发布。

以下图为例，通过标准运维的“原子“对应用服务节点进行执行命令及分发文件操作。当执行任务期间如果出现“异常情况”时，则给负责人通知提示，并且暂停任务，通过以上分解的流程编排步骤，实现应用自动发布。同时，标准运维“并行网关”可以实现流程同步进行，并将通用流程编入“子流程”，结合输入输出参数等满足更复杂的应用发布场景，实现一次编排，多次使用的效果。
![sopsyp](https://upload-images.jianshu.io/upload_images/16384352-bda3c189646b5cb0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000)

整个发布过程分解如下：

1. 应用包获取
应用包获取可根据应用不同情况获取发布包，通过从发布代码分支拉取源码之后，如果是类型JAVA编译类型的jar包或者war包，可通过在对应脚本区域根据应用情况自行编写生成包的编译脚本，即执行编译脚本生对应的包；如果是文件夹类型可通过直接打包成压缩发布包；然后提交到发布包存储库。
2. 应用发布包存储库
应用发布包存储库可以是共享存储/SVN仓库/GIT仓库等。为已部署或要求部署的应用发布包文件提供安全的存储。这可以确保部署的文件版本是可追溯的，并且保证各环境中部署的文件是相同的。
3. 应用服务停止
4. 发布包备份&分发
5. 应用服务启动
6. 应用服务状态检测&状态通知

# 实际案例

下面实际案例中的发版场景为例，简单介绍一下标准运维的设计过程。为了演示方便，这里对发版过程进行了一些简化：
![sops-02-02](http://img.yuandingit.com/sops-02-02.png)

简单来说，以上发版流程为运维人员从开发人员那里获得到包后，首先需要分发到服务器，然后放到对应的位置，然后执行解压、重启等到一系列操作。

虽然以上操作貌似简单，但是设想一下，如果发版是在凌晨两点的时候进行呢？如果每天待发版的系统有数十套之多呢？如果一遍一遍照着文档，人肉手工执行，稍不注意，可能就导致本月的绩效就没了。虽然对于一些简单的场景，可以通过写一些脚本，来简化操作。可是，如果脚本的健壮性不好，或者人为误操作，传错了包等问题，还是会存在很大的安全风险。

可能经验丰富、水平较高的运维工程师，会想到通过Ansible、Puppet等开源的自动化运维工具来操作。但是剧本的编写并不简单，另外就是出现了意外情况，排查起来也会很麻烦。并且一个小小的发版，还要动用公司的骨干人员，岂不是杀鸡用牛刀吗！可是如果交给公司的实习人员，万一数据库再被搞没了，公司岂不是要黄。另外对于一个初出茅庐的实习生，小试牛刀，便搞垮的一个数据库，传出去，名声也不好。

如果使用蓝鲸的标准运维，运维人员利用标准运维强悍的跨系统编排能力，串连碎片步骤从而提高发布效率，极大的降低人员误操作的风险。流程的整个编排过程非常容易上手，一次编排，多次使用。

先看下最终流程编排的效果：

![sops-02-03](http://img.yuandingit.com/sops-02-03.png)

设计过程

![sops-02-04](http://img.yuandingit.com/sops-02-04.png)

过程说明：

1. 将包在测试环境部署，验证通过后，将测试包，流转到到生产环境的仓库。到了发版时间，运维人员点击，新建任务，执行即可。
2. 通过（shell、python、bat、perl）脚本，验证此次发版包的信息，名称、MD5、时间等信息，如果信息不匹配，发送告警通知后暂停，等待相关人员介入。
3. 通过作业平台，分发文件到多个主机，如果由于未知原因造成分发失败，可以发送告警通知后暂停，等待相关人员介入，也可可以手动执行“重试”操作。
4. 编写部署脚本，进行小批量部署，如果有一台部署失败，便会发送告警通知，然后暂停，等待相关人员介入或者跳过。
5. 检验试部署无误后，便可以进行大批量部署。同样的，如果某一台因为意外情况发版失败，便会告警通知。
6. 发版结束后，会发送通知信息，通知管理员此次发版结束。

可以看到，通过标准运维编排固化后的发版流程，具有以下特点：

1. 整个流程执行过程中，每一步操作如果失败，都会及时触发告警，运维人员可以快速定位故障；
2. 通过图形界面实时展示任务执行状态，直观地感知当前任务的进度；
3. 运维人员可以选择执行发版操作的节点，比如只更新部分主机；
4. 避免登录服务器，降低人为误操作风险；
5. 用户在任务记录页面，可以追溯之前的任务执行情况；
6. 用户可以选择上面的流程模板创建出一个轻应用，这个轻应用可以在蓝鲸PaaS的应用市场中打开或添加到桌面，对使用人员而言，轻应用只需要关注一个流程模板的参数填写和任务操作，由于页面足够的简洁和友好，一个非技术人员也可以通过轻应用执行任务，这也就是标准运维提供的自助化服务之一。
7. 标准运维为用户提供了“职能化中心”功能，可以让运维将业务日常标准化的发布、变更等工作交给职能化人员（业务操作员，负责实施运维工作中常规性、重复性的操作）来操作，让业务运维有更多时间和精力去优化和提升业务的质量和体验。
8. 可以对其进行二次开发。比如支持定时自动发版等，开发自己适用的标准运维插件，实现真正的无人值守。

![sops-02-05](http://img.yuandingit.com/sops-02-05.png)

# 总结

以上只是一个简化后的发版流程，用户可以在以上示例的基础上，轻松扩展和定制满足自身需求的任意场景，包括：

* 运维场景：发布、变更、开区、扩缩容，资源交付、容灾切换等执行类操作
* 其他场景：监控告警、配置管理、开发工具、企业IT、办公应用、其它
